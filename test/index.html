<!DOCTYPE html>
<html lang="en">
<head>
    <title>FZWID</title>
    <meta charset="UTF-8">

    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>
    <script>
        WebAssembly.instantiateStreaming(fetch("fzwid.wasm")).then(obj =>{
            let Module  = obj.instance.exports;
            let memory  = new Uint8Array(obj.instance.exports.memory.buffer);
            let decoder = new TextDecoder();

            function decodeInstructions(binary) {
                let stack       = Module.stackSave();
                let input_pos   = Module.stackAlloc(binary.length);
                let output_pos  = Module.stackAlloc(1 << 20);

                // Set binary at input pos.
                memory.set(binary, input_pos);

                // Decode instructions and set the result at output pos.
                let length = Module.decode_instructions(output_pos, input_pos, binary.length);

                // Decode result string.
                let decoded = decoder.decode(memory.subarray(output_pos, (output_pos + length)));

                // Set document style and print the result.
                document.body.style.fontFamily  = 'Jetbrains Mono';
                document.body.style.whiteSpace  = 'pre-wrap';
                document.body.textContent       = decoded;

                // Restore stack.
                Module.stackRestore(stack);
            }

            decodeInstructions(new Uint8Array([
                0x31, 0xC0, 0xB0, 0x3C, 0x0F, 0x05
            ]));

            window.ondragover = function (e) {
                e.preventDefault();
            };

            window.ondrop = function (e) {
                e.preventDefault();
                e.dataTransfer.files[0].arrayBuffer()
                    .then(res => new Uint8Array(res))
                    .then(decodeInstructions);
            };
        });
    </script>
</body>
</html>
